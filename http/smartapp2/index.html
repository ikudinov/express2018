<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Smart app</title>
  <link rel="stylesheet" href="styles.css">
  <script src="vue.js"></script>
</head>
<body>
  <div id="app" class="todoapp">
    <div class="overlay" v-if="loading">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin:auto;background:transparent;display:block;" width="200px" height="200px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
        <path d="M43 50A7 7 0 0 0 57 50A7 7.9 0 0 1 43 50" fill="#c5c5c5" stroke="none" transform="rotate(167.878 50 50.45)">
          <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" keyTimes="0;1" values="0 50 50.45;360 50 50.45"></animateTransform>
        </path>
      </svg>
    </div>

    <!-- task list -->
    <div v-if="page === 'list'">
      <header class="header">
        <h1>tasks</h1>
        <button @mouseup="goToAddTask" class="header_add-button">+</button>
      </header>
      <section class="main" v-show="taskList.length" v-cloak>
        <ul class="todo-list">
          <li v-for="task in taskList" class="todo" @click="goToTask(task.Id)">
            <div class="view">
              <label>{{ task.Title }}</label>
              <div class="view__due">{{ task.Body || ('due ' + task.DueDate.substr(0, 10)) }}</div>
              <div class="view__status">{{ task.Status }}</div>
              <div class="view__priority">{{ task.Priority }}</div>
            </div>
          </li>
        </ul>
      </section>
    </div>

    <!-- single task -->
    <div v-if="page === 'task' && !!task">
      <header class="header">
        <h1>task #{{task.Id}}</h1>
      </header>
      <section class="main">
        <ul class="todo-list">
          <li class="task">
            <div class="task__title">{{ task.Title }}</div>
            <div v-if="author" class="task__author">Author {{ author.Title }} | {{ author.Email }}</div>
            <div class="task__date">Start date {{ task.StartDate.substr(0, 10) }}</div>
            <div class="task__date">End date {{ task.DueDate.substr(0, 10) }}</div>
            <div class="task__status">{{ task.Status }} <div class="task__priority">| Priority {{ task.Priority }}</div></div>
            <div v-if="task.Body">{{ task.Body }}</div>
            <button @mouseup="goToList" class="task__close">âœ•</button>
          </li>
        </ul>
      </section>
    </div>

    <!-- add task -->
    <div v-if="page === 'add'">
      <header class="header">
        <h1>add task</h1>
      </header>
      <section class="main">
        <ul class="todo-list">
          <li class="form">
            <span>
              <label for="title">Title</label>
              <input type="text" class="form__input" name="title" v-model="form.title" />
            </span>
            <span>
              <label for="body">Body</label>
              <input type="text" class="form__input" name="body" v-model="form.body" />
            </span>
            <button @mouseup="save" class="form__submit">SAVE</button>
            <button @mouseup="goToList" class="form__cancel">CANCEL</button>
          </li>
        </ul>
      </section>
    </div>
  </div>

  <script>
    const app = new Vue({
      el: '#app',

      data: {
        page: 'list',
        task: null,
        taskList: [],
        // page: 'add',
        // page: 'task',
        // task: { Title: 'testing', StartDate: '2019-12-12', DueDate: '2019-12-12', Status: 'Not started', Priority: 'Low' },
        // taskList: [{ Title: 'testing', DueDate: '2019-12-12', Status: 'Not started', Priority: 'Low' }],
        form: {
          title: '',
          body: '',
        },
        author: {},
        loading: true,
      },

      mounted: function () {
        const vm = this

        window.handleResponse = ({ type, payload }) => {
          if (type === 'getList') vm.handleListResponse(payload);
          if (type === 'getTask') vm.handleTaskResponse(payload);
          if (type === 'getAuthor') vm.handleAuthorResponse(payload);
          if (type === 'addTask') {
            vm.sendRequest({ type: 'getList', payload: '' });
            this.page = 'list';
          }
        }

        vm.sendRequest({ type: 'getList', payload: '' });
      },

      methods: {
        sendRequest: ({ type, payload }) => {
          if (!window.webkit || !window.webkit.messageHandlers) {
            return;
          }
          window.webkit.messageHandlers.jsHandler.postMessage({ type, payload });
        },
        handleListResponse: function(response) {
          this.loading = false;
          this.taskList = response && response.d && response.d.results || [];
        },
        handleTaskResponse: function(response) {
          this.page = 'task';
          this.task = response && response.d || null;
          this.loading = false;
          if (this.task.AuthorId) {
            this.sendRequest({ type: 'getAuthor', payload: JSON.stringify({ id: this.task.AuthorId }) });
          }
        },
        handleAuthorResponse: function(response) {
          this.author = response && response.d || {};
        },
        goToList: function() {
          this.page = 'list';
        },
        goToTask: function(id) {
          this.loading = true;
          this.sendRequest({ type: 'getTask', payload: JSON.stringify({ id }) });
        },
        goToAddTask: function() {
          this.form.title = '';
          this.form.body = '';
          this.page = 'add';
        },
        save: function() {
          this.loading = true;
          this.sendRequest({
            type: 'addTask',
            payload: {
              title: form.title,
              body: form.body,
            },
          });
        },
      }
    })
  </script>
</body>
</html>
